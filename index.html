<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Operação Barricada Zero | Dashboard Estratégico Avançado</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    :root {
      --primary: #0d47a1;
      --primary-dark: #002171;
      --primary-light: #5472d3;
      --success: #2e7d32;
      --success-light: #e8f5e9;
      --warning: #f9a825;
      --warning-light: #fff8e1;
      --danger: #d32f2f;
      --danger-light: #ffebee;
      --info: #0288d1;
      --info-light: #e1f5fe;
      --light: #f5f7fa;
      --gray-100: #f8f9fa;
      --gray-200: #e9ecef;
      --gray-300: #dee2e6;
      --gray-600: #6c757d;
      --gray-800: #343a40;
      --shadow-sm: 0 2px 8px rgba(0,0,0,0.05);
      --shadow-md: 0 4px 16px rgba(0,0,0,0.08);
      --shadow-lg: 0 8px 32px rgba(0,0,0,0.12);
      --shadow-xl: 0 12px 48px rgba(0,0,0,0.15);
    }
    
    * { box-sizing: border-box; }
    
    body { 
      font-family: 'Inter', sans-serif; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #263238; 
      margin: 0; 
      padding: 20px;
      min-height: 100vh;
    }
    
    .container {
      max-width: 1600px;
      margin: 0 auto;
    }
    
    /* HEADER */
    header { 
      background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
      color: white; 
      padding: 40px; 
      text-align: center; 
      border-radius: 24px; 
      margin-bottom: 40px; 
      box-shadow: var(--shadow-xl);
      position: relative;
      overflow: hidden;
    }
    
    header::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -10%;
      width: 500px;
      height: 500px;
      background: rgba(255,255,255,0.05);
      border-radius: 50%;
    }
    
    header h1 { 
      font-size: 48px; 
      margin: 0; 
      font-weight: 800;
      text-shadow: 2px 2px 8px rgba(0,0,0,0.2);
      position: relative;
    }
    
    header p {
      margin: 15px 0 0;
      opacity: 0.95;
      font-size: 20px;
      font-weight: 500;
      position: relative;
    }
    
    .header-stats {
      display: flex;
      justify-content: center;
      gap: 40px;
      margin-top: 30px;
      position: relative;
    }
    
    .header-stat {
      text-align: center;
    }
    
    .header-stat-value {
      font-size: 36px;
      font-weight: 700;
      display: block;
    }
    
    .header-stat-label {
      font-size: 14px;
      opacity: 0.9;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-top: 5px;
    }
    
    /* UPLOAD SECTION */
    .upload { 
      text-align: center; 
      background: white; 
      padding: 50px; 
      border-radius: 24px; 
      box-shadow: var(--shadow-lg);
      margin-bottom: 40px;
      border: 3px dashed var(--gray-300);
      transition: all 0.3s ease;
    }
    
    .upload:hover {
      border-color: var(--primary);
      box-shadow: var(--shadow-xl);
    }
    
    .upload h2 {
      color: var(--primary);
      margin-bottom: 30px;
      font-size: 32px;
      font-weight: 700;
    }

    .action-buttons {
      display: flex;
      justify-content: center;
      gap: 20px;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .btn { 
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white; 
      border: none; 
      padding: 18px 40px; 
      border-radius: 16px; 
      font-size: 18px; 
      cursor: pointer; 
      font-weight: 700;
      box-shadow: var(--shadow-md);
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 1px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .btn:hover { 
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .btn-pdf {
      background: linear-gradient(135deg, #d32f2f 0%, #b71c1c 100%);
    }

    .btn-pdf:hover {
      background: linear-gradient(135deg, #e53935 0%, #c62828 100%);
    }
    
    /* FILTROS */
    .filtros-container {
      background: white;
      padding: 25px 30px;
      border-radius: 20px;
      box-shadow: var(--shadow-lg);
      margin-bottom: 30px;
      border-top: 6px solid var(--primary);
    }
    
    .filtros-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .filtros-title {
      font-size: 24px;
      font-weight: 700;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .btn-filtro {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s ease;
    }
    
    .btn-filtro:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }
    
    .btn-limpar {
      background: linear-gradient(135deg, var(--danger) 0%, #b71c1c 100%);
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s ease;
    }
    
    .btn-limpar:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
      background: linear-gradient(135deg, #e53935 0%, #c62828 100%);
    }
    
    .filtros-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 15px;
    }
    
    .filtro-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .filtro-label {
      font-size: 14px;
      font-weight: 600;
      color: var(--gray-800);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .filtro-select, .filtro-input {
      padding: 12px 15px;
      border: 2px solid var(--gray-300);
      border-radius: 12px;
      font-family: 'Inter', sans-serif;
      font-size: 15px;
      transition: all 0.3s ease;
    }
    
    .filtro-select:focus, .filtro-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(13, 71, 161, 0.1);
    }
    
    /* GRID SYSTEM */
    .grid { 
      display: grid; 
      gap: 30px; 
      margin-top: 30px; 
    }
    
    .grid-4 { grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); }
    .grid-3 { grid-template-columns: repeat(auto-fit, minmax(360px, 1fr)); }
    .grid-2 { grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); }
    .grid-1 { grid-template-columns: 1fr; }
    
    /* CARDS */
    .card {
      background: white;
      padding: 30px;
      border-radius: 20px;
      box-shadow: var(--shadow-md);
      border-left: 6px solid var(--primary);
      text-align: center;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-xl);
    }
    
    .card::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(13,71,161,0.03) 0%, transparent 70%);
      pointer-events: none;
    }
    
    .card h3 {
      margin: 0 0 15px 0;
      font-size: 18px;
      color: var(--gray-600);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .card-icon {
      font-size: 48px;
      margin-bottom: 15px;
      opacity: 0.2;
      position: absolute;
      right: 20px;
      top: 20px;
    }
    
    .big { 
      font-size: 64px; 
      font-weight: 800; 
      color: var(--primary); 
      margin: 20px 0;
      line-height: 1;
      position: relative;
    }
    
    .medium {
      font-size: 36px;
      font-weight: 700;
      color: var(--primary);
      margin: 15px 0;
    }
    
    /* MODAL */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      z-index: 1000;
      overflow-y: auto;
    }
    
    .modal-content {
      background: white;
      width: 90%;
      max-width: 1000px;
      margin: 50px auto;
      border-radius: 20px;
      box-shadow: var(--shadow-xl);
      animation: modalFadeIn 0.3s ease;
    }
    
    @keyframes modalFadeIn {
      from { opacity: 0; transform: translateY(-30px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .modal-header {
      background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
      color: white;
      padding: 25px 30px;
      border-radius: 20px 20px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .modal-title {
      font-size: 24px;
      font-weight: 700;
      margin: 0;
    }
    
    .modal-close {
      background: none;
      border: none;
      color: white;
      font-size: 28px;
      cursor: pointer;
      padding: 0;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: background 0.3s ease;
    }
    
    .modal-close:hover {
      background: rgba(255,255,255,0.1);
    }
    
    .modal-body {
      padding: 30px;
      max-height: 70vh;
      overflow-y: auto;
    }
    
    .modal-section {
      margin-bottom: 25px;
    }
    
    .modal-section h4 {
      color: var(--primary);
      font-size: 18px;
      margin: 0 0 15px 0;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--gray-200);
    }
    
    /* CPA CARDS */
    .cpa-card {
      background: white;
      border-radius: 16px;
      padding: 20px;
      box-shadow: var(--shadow-md);
      transition: all 0.3s ease;
      border-top: 4px solid var(--primary);
      cursor: pointer;
      display: flex;
      flex-direction: column;
      min-height: 400px;
      position: relative;
      overflow: hidden;
    }
    
    .cpa-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-lg);
    }
    
    .cpa-header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 15px;
      flex-shrink: 0;
    }
    
    .cpa-icon {
      width: 60px;
      height: 60px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: blue;
      font-size: 28px;
      font-weight: 700;
      position: relative;
      overflow: hidden;
      text-align: center;
      flex-shrink: 0;
      padding: 5px;
    }
    
    .cpa-icon-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
      position: relative;
    }
    
    .cpa-icon-content::before {
      content: '⚔️';
      font-size: 30px;
      position: absolute;
      top: 2px;
      opacity: 0.9;
    }
    
    .cpa-info {
      flex: 1;
      min-width: 0;
    }
    
    .cpa-info h4 {
      margin: 0;
      font-size: 22px;
      color: var(--primary-blue);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .cpa-info p {
      margin: 5px 0 0;
      color: var(--gray-600);
      font-size: 14px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .cpa-chart-container {
      height: 100px;
      margin: 10px 0;
      position: relative;
      flex-shrink: 0;
    }
    
    .cpa-chart-canvas {
      width: 100% !important;
      height: 100px !important;
    }
    
    .cpa-details {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 10px;
      flex-shrink: 0;
    }
    
    .cpa-detail {
      background: var(--gray-100);
      padding: 12px;
      border-radius: 10px;
      text-align: center;
      overflow: hidden;
    }
    
    .cpa-detail-value {
      font-size: 16px;
      font-weight: 700;
      color: var(--primary);
      display: block;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .cpa-detail-label {
      font-size: 11px;
      color: var(--black-600);
      margin-top: 3px;
      text-transform: uppercase;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    /* INSIGHTS */
    .insight { 
      padding: 15px 20px; 
      border-radius: 12px; 
      font-weight: 600; 
      font-size: 15px; 
      margin-top: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: all 0.3s ease;
    }
    
    .insight i {
      font-size: 20px;
    }
    
    .insight.success { 
      background: var(--success-light); 
      color: var(--success);
      border: 2px solid rgba(46,125,50,0.2);
    }
    
    .insight.warning { 
      background: var(--warning-light); 
      color: #f57c00;
      border: 2px solid rgba(249,168,37,0.2);
    }
    
    .insight.danger {
      background: var(--danger-light);
      color: var(--danger);
      border: 2px solid rgba(211,47,47,0.2);
    }
    
    .insight.info {
      background: var(--info-light);
      color: var(--info);
      border: 2px solid rgba(2,136,209,0.2);
    }
    
    /* SECTION HEADERS */
    .section-header {
      text-align: center;
      margin: 60px 0 30px;
      position: relative;
    }
    
    .section-header h2 {
      color: white;
      font-size: 38px;
      font-weight: 800;
      margin: 0;
      text-shadow: 2px 2px 8px rgba(0,0,0,0.3);
      display: inline-block;
      padding: 0 30px;
      position: relative;
    }
    
    .section-header::before,
    .section-header::after {
      content: '';
      position: absolute;
      top: 50%;
      width: 30%;
      height: 2px;
      background: rgba(255,255,255,0.3);
    }
    
    .section-header::before { left: 0; }
    .section-header::after { right: 0; }
    
    /* CHARTS */
    .chart-container {
      background: white;
      padding: 30px;
      border-radius: 20px;
      box-shadow: var(--shadow-md);
      margin-bottom: 30px;
      position: relative;
      height: 400px;
    }
    
    .chart-title {
      text-align: center;
      font-size: 24px;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 25px;
    }
    
    .comparative-chart {
      height: 350px;
      width: 100%;
    }
    
    canvas { 
      border-radius: 12px;
      max-height: 400px;
    }
    
    /* AREA CARDS */
    .area-card {
      background: white;
      padding: 25px;
      border-radius: 16px;
      box-shadow: var(--shadow-md);
      transition: all 0.3s ease;
    }
    
    .area-card:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow-lg);
    }
    
    .area-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .area-name {
      font-size: 22px;
      font-weight: 700;
      color: var(--primary-dark);
    }
    
    .area-badge {
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .area-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin: 20px 0;
    }
    
    .area-stat {
      text-align: center;
      padding: 15px;
      background: var(--gray-100);
      border-radius: 12px;
    }
    
    .area-stat-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--primary);
    }
    
    .area-stat-label {
      font-size: 12px;
      color: var(--gray-600);
      margin-top: 5px;
      text-transform: uppercase;
    }

    .progress-container {
      margin: 15px 0;
    }

    .progress-label {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 14px;
      font-weight: 600;
    }

    .progress-bar {
      width: 100%;
      height: 12px;
      background: var(--gray-200);
      border-radius: 10px;
      overflow: hidden;
    }

    .progress {
      height: 100%;
      border-radius: 10px;
      transition: width 0.5s ease;
    }
    
    /* RANKING TABLE */
    .ranking-table {
      width: 100%;
      background: white;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: var(--shadow-md);
    }
    
    .ranking-table th {
      background: var(--primary);
      color: white;
      padding: 20px;
      text-align: left;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-size: 14px;
    }
    
    .ranking-table td {
      padding: 18px 20px;
      border-bottom: 1px solid var(--gray-200);
    }
    
    .ranking-table tr:hover {
      background: var(--gray-100);
    }
    
    .ranking-position {
      font-size: 24px;
      font-weight: 800;
      color: var(--primary);
      width: 60px;
    }
    
    .ranking-medal {
      font-size: 28px;
    }
    
    /* TABS */
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
      background: white;
      padding: 10px;
      border-radius: 16px;
      box-shadow: var(--shadow-md);
    }
    
    .tab {
      flex: 1;
      padding: 15px 25px;
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      color: var(--gray-600);
      border-radius: 12px;
      transition: all 0.3s ease;
    }
    
    .tab:hover {
      background: var(--gray-100);
    }
    
    .tab.active {
      background: var(--primary);
      color: white;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    /* FOOTER */
    footer { 
      text-align: center; 
      padding: 60px 20px; 
      color: white; 
      font-size: 16px;
      margin-top: 60px;
    }
    
    /* LISTAS EM MODAL */
    .localidades-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 10px;
      margin-top: 15px;
    }
    
    .localidade-item {
      background: var(--gray-100);
      padding: 10px 15px;
      border-radius: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.3s ease;
    }
    
    .localidade-item:hover {
      background: var(--gray-200);
    }
    
    .localidade-nome {
      font-weight: 500;
      font-size: 14px;
    }
    
    .localidade-count {
      background: var(--primary-light);
      color: white;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      min-width: 30px;
      text-align: center;
    }
    
    /* MODAL PDF PREVIEW */
    .pdf-preview-container {
      width: 100%;
      height: 70vh;
      border: 2px solid var(--gray-300);
      border-radius: 8px;
      overflow: hidden;
      margin: 15px 0;
      position: relative;
      z-index: 1001;
    }
    
    .pdf-preview-iframe {
      width: 100%;
      height: 100%;
      border: none;
      position: relative;
      z-index: 1001;
    }
    
    .pdf-actions {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-top: 20px;
      padding: 20px;
      border-top: 1px solid var(--gray-200);
    }
    
    /* MENSAGENS */
    .mensagem {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 30px;
      border-radius: 12px;
      color: white;
      font-weight: 600;
      box-shadow: var(--shadow-md);
      display: flex;
      align-items: center;
      gap: 10px;
      animation: slideIn 0.3s ease;
      z-index: 9999;
    }
    
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    .mensagem.success { background: var(--success); }
    .mensagem.warning { background: #f57c00; }
    .mensagem.danger { background: var(--danger); }
    .mensagem.info { background: var(--info); }
    
    /* ESTILOS PARA FILTROS */
    #statusFiltros {
      font-size: 14px;
      color: var(--gray-600);
      margin-top: 10px;
      padding: 10px;
      background: var(--gray-100);
      border-radius: 8px;
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Operação Barricada Zero</h1>
      <p>Dashboard Estratégico Avançado para Análise Operacional</p>
      <div class="header-stats">
        <div class="header-stat">
          <span class="header-stat-value" id="totalRemocoes">0</span>
          <span class="header-stat-label">Remoções</span>
        </div>
        <div class="header-stat">
          <span class="header-stat-value" id="totalVias">0</span>
          <span class="header-stat-label">Vias Liberadas</span>
        </div>
        <div class="header-stat">
          <span class="header-stat-value" id="totalPeso">0</span>
          <span class="header-stat-label">Toneladas</span>
        </div>
        <div class="header-stat">
          <span class="header-stat-value" id="totalDias">0</span>
          <span class="header-stat-label">Dias</span>
        </div>
      </div>
    </header>

    <div class="upload">
      <h2>Carregar Planilha Excel</h2>
      <div class="action-buttons">
        <input type="file" id="uploadExcel" accept=".xlsx, .xls" style="display: none;">
        <button class="btn" onclick="document.getElementById('uploadExcel').click();">
          <i class="fas fa-upload"></i> Carregar Excel
        </button>
        <button class="btn btn-pdf" onclick="visualizarPDF()">
          <i class="fas fa-file-pdf"></i> Gerar PDF
        </button>
      </div>
    </div>

    <div class="filtros-container">
      <div class="filtros-header">
        <div class="filtros-title">
          <i class="fas fa-filter"></i> Filtros Avançados
        </div>
        <button class="btn-filtro" onclick="aplicarFiltros()">
          <i class="fas fa-check"></i> Aplicar
        </button>
        <button class="btn-limpar" onclick="limparFiltros()">
          <i class="fas fa-times"></i> Limpar Filtros
        </button>
      </div>
      <div class="filtros-grid">
        <div class="filtro-group">
          <label class="filtro-label">CPA</label>
          <select id="filtroCPA" class="filtro-select">
            <option value="todos">Todos</option>
          </select>
        </div>
        <div class="filtro-group">
          <label class="filtro-label">BPM</label>
          <select id="filtroBPM" class="filtro-select">
            <option value="todos">Todos</option>
          </select>
        </div>
        <div class="filtro-group">
          <label class="filtro-label">Município</label>
          <select id="filtroMunicipio" class="filtro-select">
            <option value="todos">Todos</option>
          </select>
        </div>
      </div>
      <div id="statusFiltros"></div>
    </div>

    <div class="section-header">
      <h2>KPIs Principais</h2>
    </div>
    <div class="grid grid-4" id="cardsTotais"></div>

    <div class="section-header">
      <h2>Insights Relevantes</h2>
    </div>
    <div class="grid grid-1" id="insightsCard"></div>

    <div class="section-header">
      <h2>Desempenho por CPA</h2>
    </div>
    <div class="grid grid-3" id="cardsCPAs"></div>

    <div class="section-header">
      <h2>Desempenho por BPM</h2>
    </div>
    <div class="grid grid-3" id="cardsBPMs"></div>

    <div class="section-header">
      <h2>Análise Comparativa</h2>
    </div>
    <div class="tabs">
      <button class="tab active" data-tab="tab-cpa">Rank CPAs</button>
      <button class="tab" data-tab="tab-bpm">Rank BPMs</button>
    </div>
    
    <div class="tab-content active" id="tab-cpa">
      <div class="chart-container">
        <div class="chart-title">Comparativo de Desempenho - CPAs</div>
        <canvas id="graficoComparativoCPA" class="comparative-chart"></canvas>
      </div>
      <table class="ranking-table" id="tabelaComparativaCPA"></table>
    </div>
    
    <div class="tab-content" id="tab-bpm">
      <div class="chart-container">
        <div class="chart-title">Comparativo de Desempenho - BPMs (Top 10)</div>
        <canvas id="graficoComparativoBPM" class="comparative-chart"></canvas>
      </div>
      <table class="ranking-table" id="tabelaComparativaBPM"></table>
    </div>

    <footer>
      @ 2025 - GSI - Operações Estratégicas - Todos os direitos reservados
    </footer>
  </div>

  <!-- MODAL PDF -->
  <div id="modalPDF" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <span class="modal-title">Pré-visualização do PDF</span>
        <button class="modal-close" onclick="fecharModal('modalPDF')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="pdf-preview-container">
          <iframe id="pdfPreview" class="pdf-preview-iframe"></iframe>
        </div>
        <div class="pdf-actions">
          <button class="btn" onclick="baixarPDF()">
            <i class="fas fa-download"></i> Baixar PDF
          </button>
          <button class="btn btn-limpar" onclick="fecharModal('modalPDF')">
            <i class="fas fa-times"></i> Fechar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL CPA DETAILS -->
  <div id="modalCPA" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <span class="modal-title" id="modalCPATitle"></span>
        <button class="modal-close" onclick="fecharModal('modalCPA')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="modal-section">
          <h4>Comandante</h4>
          <p id="cpaComandante"></p>
        </div>
        <div class="modal-section">
          <h4>Áreas/Equipes Vinculadas</h4>
          <div id="cpaAreasList"></div>
        </div>
        <div class="modal-section">
          <h4>Batalhões e Áreas de Atuação</h4>
          <div id="cpaBPMList"></div>
        </div>
        <div class="modal-section">
          <h4>Localidades de Atuação para Remoção de Barricadas</h4>
          <div id="cpaLocalidadesList"></div>
        </div>
        <div class="pdf-actions">
          <button class="btn btn-pdf" onclick="gerarPDFCPA()">
            <i class="fas fa-file-pdf"></i> Gerar PDF
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ============================================================================
    // VARIÁVEIS GLOBAIS
    // ============================================================================
    let dadosBrutos = null;
    let dadosFiltrados = null;
    let filtrosAtivos = {
      cpa: 'todos',
      bpm: 'todos',
      municipio: 'todos'
    };

    const colors = {
      '1ª': '#2196f3',
      '2ª': '#f44336',
      '3ª': '#4caf50',
      '4ª': '#ff9800'
    };

    let cpaComandantes = {};
    let cpaDetails = {};
    let cpaAreas = {};
    let cpaLocalidades = {};
    
    let graficoComparativoCPA = null;
    let graficoComparativoBPM = null;

    // ============================================================================
    // FUNÇÕES AUXILIARES
    // ============================================================================
    function mostrarMensagem(texto, classe) {
      const msg = document.createElement('div');
      msg.className = `mensagem ${classe}`;
      msg.innerHTML = `<i class="fas fa-${classe === 'success' ? 'check-circle' : classe === 'warning' ? 'exclamation-triangle' : classe === 'danger' ? 'times-circle' : 'info-circle'}"></i> ${texto}`;
      document.body.appendChild(msg);
      setTimeout(() => msg.remove(), 5000);
    }

    function abrirModal(id) {
      document.getElementById(id).style.display = 'flex';
    }

    function fecharModal(id) {
      document.getElementById(id).style.display = 'none';
    }

    function atualizarStatusFiltros() {
      const status = document.getElementById('statusFiltros');
      const ativos = Object.entries(filtrosAtivos).filter(([k, v]) => v !== 'todos').map(([k, v]) => `${k}: ${v}`).join(', ');
      status.textContent = ativos ? `Filtros ativos: ${ativos}` : 'Nenhum filtro aplicado';
      status.style.display = 'block';
    }

    function limparFiltros() {
      document.getElementById('filtroCPA').value = 'todos';
      document.getElementById('filtroBPM').value = 'todos';
      document.getElementById('filtroMunicipio').value = 'todos';
      aplicarFiltros();
    }

    function excelDateToJSDate(excelDate) {
      if (!excelDate || isNaN(excelDate)) return null;
      const excelEpoch = new Date(Date.UTC(1900, 11, 30));
      const jsDate = new Date(excelEpoch.getTime() + excelDate * 86400000);
      return new Date(jsDate.getUTCFullYear(), jsDate.getUTCMonth(), jsDate.getUTCDate());
    }

    function formatarDataBR(data) {
      if (!data) return '';
      const dia = String(data.getDate()).padStart(2, '0');
      const mes = String(data.getMonth() + 1).padStart(2, '0');
      const ano = data.getFullYear();
      return `${dia}/${mes}/${ano}`;
    }

    // ============================================================================
    // PROCESSAMENTO DE DADOS
    // ============================================================================
    async function processarExcel(file) {
      try {
        const arrayBuffer = await file.arrayBuffer();
        const workbook = XLSX.read(arrayBuffer, { type: 'array' });

        const globalSheet = workbook.Sheets['GLOBAL'];
        const globalData = XLSX.utils.sheet_to_json(globalSheet, { header: 1 });

        const headers = globalData[0];
        const dataRows = globalData.slice(1).filter(row => row.some(cell => cell));

        dadosBrutos = {
          rows: dataRows,
          totais: { barricadas: 0, vias: 0, peso: 0, dias: 0 },
          cpas: {},
          bpms: {},
          municipios: new Set(),
          evolucao: {}
        };

        // Processar sheet CPA x BTL
        const cpaBtlSheet = workbook.Sheets['CPA x BTL'];
        if (cpaBtlSheet) {
          const cpaBtlData = XLSX.utils.sheet_to_json(cpaBtlSheet, { header: ['CPA', 'CMT', 'TEL', 'BPM', 'AREA', 'AREAS'] }).slice(1);
          let currentCPA = null;
          let currentComandante = null;
          cpaBtlData.forEach(row => {
            if (row.CPA) {
              currentCPA = row.CPA.trim().replace('°', 'ª');
              currentComandante = row.CMT ? row.CMT.trim() : currentComandante;
              cpaComandantes[currentCPA] = currentComandante;
              if (!cpaDetails[currentCPA]) cpaDetails[currentCPA] = [];
            }
            if (currentCPA && row.BPM) {
              cpaDetails[currentCPA].push({
                bpm: row.BPM.trim(),
                area: row.AREA ? row.AREA.trim() : '',
                areasAtuacao: row.AREAS ? row.AREAS.trim() : ''
              });
            }
          });
        }

        // Inicializar objetos
        cpaLocalidades = {};
        let datasJS = [];

        dataRows.forEach(row => {
          const dataExcel = parseFloat(row[0]) || null;
          let cpa = (row[8] || '').trim();
          cpa = cpa.replace('°', 'ª');
          const area = (row[1] || '').trim().toUpperCase();
          const bpm = (row[10] || '').trim();
          const municipio = (row[2] || '').trim();
          const remocoes = parseFloat(row[5]) || 0;
          const vias = parseFloat(row[6]) || 0;
          const peso = parseFloat(row[7]) || 0;

          if (cpa && remocoes > 0) {
            dadosBrutos.totais.barricadas += remocoes;
            dadosBrutos.totais.vias += vias;
            dadosBrutos.totais.peso += peso;

            if (dataExcel) {
              const dataJS = excelDateToJSDate(dataExcel);
              if (dataJS) {
                datasJS.push(dataJS);
                const dateStr = formatarDataBR(dataJS);
                if (!dadosBrutos.evolucao[dateStr]) dadosBrutos.evolucao[dateStr] = { barricadas: 0, vias: 0, peso: 0 };
                dadosBrutos.evolucao[dateStr].barricadas += remocoes;
                dadosBrutos.evolucao[dateStr].vias += vias;
                dadosBrutos.evolucao[dateStr].peso += peso;
              }
            }

            if (!dadosBrutos.cpas[cpa]) dadosBrutos.cpas[cpa] = { barricadas: 0, vias: 0, peso: 0, bpms: new Set(), eficiencia: 0 };
            dadosBrutos.cpas[cpa].barricadas += remocoes;
            dadosBrutos.cpas[cpa].vias += vias;
            dadosBrutos.cpas[cpa].peso += peso;
            dadosBrutos.cpas[cpa].eficiencia = dadosBrutos.cpas[cpa].barricadas / (dadosBrutos.cpas[cpa].vias || 1);

            if (!cpaAreas[cpa]) cpaAreas[cpa] = new Set();
            if (area) cpaAreas[cpa].add(area);

            const bpmKey = `${cpa}-${bpm}`;
            if (!dadosBrutos.bpms[bpmKey]) dadosBrutos.bpms[bpmKey] = { cpa, bpm, barricadas: 0, vias: 0, peso: 0, eficiencia: 0 };
            dadosBrutos.bpms[bpmKey].barricadas += remocoes;
            dadosBrutos.bpms[bpmKey].vias += vias;
            dadosBrutos.bpms[bpmKey].peso += peso;
            dadosBrutos.bpms[bpmKey].eficiencia = dadosBrutos.bpms[bpmKey].barricadas / (dadosBrutos.bpms[bpmKey].vias || 1);

            dadosBrutos.cpas[cpa].bpms.add(bpm);

            if (municipio) dadosBrutos.municipios.add(municipio);

            // Coletar localidades por CPA
            if (municipio && municipio.trim() !== '') {
              if (!cpaLocalidades[cpa]) cpaLocalidades[cpa] = {};
              if (!cpaLocalidades[cpa][municipio]) cpaLocalidades[cpa][municipio] = 0;
              cpaLocalidades[cpa][municipio] += remocoes;
            }
          }
        });

        // Calcular dias
        if (datasJS.length > 0) {
          const datasUnicas = new Set(datasJS.map(d => formatarDataBR(d)));
          dadosBrutos.totais.dias = datasUnicas.size;
          const dataInicio = new Date(Math.min(...datasJS.map(d => d.getTime())));
          const dataFim = new Date(Math.max(...datasJS.map(d => d.getTime())));
          dadosBrutos.dataInicio = dataInicio;
          dadosBrutos.dataFim = dataFim;
        } else {
          dadosBrutos.totais.dias = 0;
        }

        // Calcular percentuais
        Object.entries(dadosBrutos.cpas).forEach(([cpa, data]) => {
          data.percentualBarricadas = (data.barricadas / dadosBrutos.totais.barricadas) * 100 || 0;
        });

        // Ordenar evolução
        dadosBrutos.evolucao = Object.entries(dadosBrutos.evolucao)
          .sort((a, b) => {
            const [diaA, mesA, anoA] = a[0].split('/').map(Number);
            const [diaB, mesB, anoB] = b[0].split('/').map(Number);
            const dataA = new Date(anoA, mesA - 1, diaA);
            const dataB = new Date(anoB, mesB - 1, diaB);
            return dataA - dataB;
          })
          .map(([data, vals]) => ({ data, ...vals }));

        // Preencher filtros
        const selectCPA = document.getElementById('filtroCPA');
        selectCPA.innerHTML = '<option value="todos">Todos</option>' + 
          Object.keys(dadosBrutos.cpas).map(cpa => `<option value="${cpa}">${cpa}</option>`).join('');

        const selectBPM = document.getElementById('filtroBPM');
        const allBPMs = new Set(Object.values(dadosBrutos.bpms).map(b => b.bpm));
        selectBPM.innerHTML = '<option value="todos">Todos</option>' + 
          Array.from(allBPMs).map(bpm => `<option value="${bpm}">${bpm}</option>`).join('');

        const selectMunicipio = document.getElementById('filtroMunicipio');
        selectMunicipio.innerHTML = '<option value="todos">Todos</option>' + 
          Array.from(dadosBrutos.municipios).map(mun => `<option value="${mun}">${mun}</option>`).join('');

        aplicarFiltros();
        mostrarMensagem('Planilha processada com sucesso!', 'success');

      } catch (error) {
        console.error('Erro ao processar Excel:', error);
        mostrarMensagem('Erro ao processar planilha: ' + error.message, 'danger');
      }
    }

    function aplicarFiltros() {
      filtrosAtivos.cpa = document.getElementById('filtroCPA').value;
      filtrosAtivos.bpm = document.getElementById('filtroBPM').value;
      filtrosAtivos.municipio = document.getElementById('filtroMunicipio').value;

      let filteredRows = dadosBrutos.rows.filter(row => {
        let rowCPA = (row[8] || '').trim();
        rowCPA = rowCPA.replace('°', 'ª');
        const rowBPM = (row[10] || '').trim();
        const rowMunicipio = (row[2] || '').trim();

        return (filtrosAtivos.cpa === 'todos' || rowCPA === filtrosAtivos.cpa) &&
               (filtrosAtivos.bpm === 'todos' || rowBPM === filtrosAtivos.bpm) &&
               (filtrosAtivos.municipio === 'todos' || rowMunicipio.toLowerCase() === filtrosAtivos.municipio.toLowerCase());
      });

      dadosFiltrados = {
        totais: { barricadas: 0, vias: 0, peso: 0, dias: 0 },
        cpas: {},
        bpms: {},
        municipios: new Set(),
        evolucao: {}
      };

      let datasJSFiltradas = [];

      filteredRows.forEach(row => {
        const dataExcel = parseFloat(row[0]) || null;
        let cpa = (row[8] || '').trim();
        cpa = cpa.replace('°', 'ª');
        const bpm = (row[10] || '').trim();
        const municipio = (row[2] || '').trim();
        const remocoes = parseFloat(row[5]) || 0;
        const vias = parseFloat(row[6]) || 0;
        const peso = parseFloat(row[7]) || 0;

        if (cpa && remocoes > 0) {
          dadosFiltrados.totais.barricadas += remocoes;
          dadosFiltrados.totais.vias += vias;
          dadosFiltrados.totais.peso += peso;

          if (dataExcel) {
            const dataJS = excelDateToJSDate(dataExcel);
            if (dataJS) {
              datasJSFiltradas.push(dataJS);
              const dateStr = formatarDataBR(dataJS);
              if (!dadosFiltrados.evolucao[dateStr]) dadosFiltrados.evolucao[dateStr] = { barricadas: 0, vias: 0, peso: 0 };
              dadosFiltrados.evolucao[dateStr].barricadas += remocoes;
              dadosFiltrados.evolucao[dateStr].vias += vias;
              dadosFiltrados.evolucao[dateStr].peso += peso;
            }
          }

          if (!dadosFiltrados.cpas[cpa]) dadosFiltrados.cpas[cpa] = { barricadas: 0, vias: 0, peso: 0, bpms: new Set(), eficiencia: 0 };
          dadosFiltrados.cpas[cpa].barricadas += remocoes;
          dadosFiltrados.cpas[cpa].vias += vias;
          dadosFiltrados.cpas[cpa].peso += peso;
          dadosFiltrados.cpas[cpa].eficiencia = dadosFiltrados.cpas[cpa].barricadas / (dadosFiltrados.cpas[cpa].vias || 1);

          const bpmKey = `${cpa}-${bpm}`;
          if (!dadosFiltrados.bpms[bpmKey]) dadosFiltrados.bpms[bpmKey] = { cpa, bpm, barricadas: 0, vias: 0, peso: 0, eficiencia: 0 };
          dadosFiltrados.bpms[bpmKey].barricadas += remocoes;
          dadosFiltrados.bpms[bpmKey].vias += vias;
          dadosFiltrados.bpms[bpmKey].peso += peso;
          dadosFiltrados.bpms[bpmKey].eficiencia = dadosFiltrados.bpms[bpmKey].barricadas / (dadosFiltrados.bpms[bpmKey].vias || 1);

          dadosFiltrados.cpas[cpa].bpms.add(bpm);
          if (municipio) dadosFiltrados.municipios.add(municipio);
        }
      });

      // Calcular dias filtrados
      if (datasJSFiltradas.length > 0) {
        const datasUnicas = new Set(datasJSFiltradas.map(d => formatarDataBR(d)));
        dadosFiltrados.totais.dias = datasUnicas.size;
        const dataInicio = new Date(Math.min(...datasJSFiltradas.map(d => d.getTime())));
        const dataFim = new Date(Math.max(...datasJSFiltradas.map(d => d.getTime())));
        dadosFiltrados.dataInicio = dataInicio;
        dadosFiltrados.dataFim = dataFim;
      } else {
        dadosFiltrados.totais.dias = 0;
      }

      Object.entries(dadosFiltrados.cpas).forEach(([cpa, data]) => {
        data.percentualBarricadas = (data.barricadas / dadosFiltrados.totais.barricadas) * 100 || 0;
      });

      dadosFiltrados.evolucao = Object.entries(dadosFiltrados.evolucao)
        .sort((a, b) => {
          const [diaA, mesA, anoA] = a[0].split('/').map(Number);
          const [diaB, mesB, anoB] = b[0].split('/').map(Number);
          const dataA = new Date(anoA, mesA - 1, diaA);
          const dataB = new Date(anoB, mesB - 1, diaB);
          return dataA - dataB;
        })
        .map(([data, vals]) => ({ data, ...vals }));

      atualizarDashboard();
      atualizarStatusFiltros();
      mostrarMensagem('Filtros aplicados com sucesso!', 'success');
    }

    // ============================================================================
    // ATUALIZAÇÃO DO DASHBOARD
    // ============================================================================
    function atualizarDashboard() {
      atualizarHeaderStats();
      criarCardsTotais(dadosFiltrados);
      criarInsightsCard(dadosFiltrados);
      criarCardsCPAs(dadosFiltrados);
      criarCardsBPMs(dadosFiltrados);
      criarTabelaComparativaCPA(dadosFiltrados);
      criarTabelaComparativaBPM(dadosFiltrados);
      criarGraficosComparativos(dadosFiltrados);
    }

    function atualizarHeaderStats() {
      document.getElementById('totalRemocoes').textContent = Math.round(dadosFiltrados.totais.barricadas);
      document.getElementById('totalVias').textContent = Math.round(dadosFiltrados.totais.vias);
      document.getElementById('totalPeso').textContent = Math.round(dadosFiltrados.totais.peso);
      document.getElementById('totalDias').textContent = dadosFiltrados.totais.dias;
    }

    function criarCardsTotais(dados) {
      const grid = document.getElementById('cardsTotais');
      const insights = [
        {
          icone: 'fa-shield-alt',
          titulo: 'Remoções Totais',
          valor: Math.round(dados.totais.barricadas),
          descricao: 'Barricadas removidas',
          classe: 'info'
        },
        {
          icone: 'fa-road',
          titulo: 'Vias Liberadas',
          valor: Math.round(dados.totais.vias),
          descricao: 'Vias desobstruídas',
          classe: 'success'
        },
        {
          icone: 'fa-chart-line',
          titulo: 'Média Diária',
          valor: dados.totais.dias > 0 ? (dados.totais.barricadas / dados.totais.dias).toFixed(1) : 0,
          descricao: 'Média de remoções por dia',
          classe: 'success'
        },
        {
          icone: 'fa-weight-hanging',
          titulo: 'Total Acumulado',
          valor: Math.round(dados.totais.peso).toLocaleString('pt-BR'),
          descricao: 'Toneladas de entulho removidas',
          classe: 'warning'
        }
      ];
      
      grid.innerHTML = insights.map(insight => `
        <div class="card">
          <i class="fas ${insight.icone} card-icon"></i>
          <h3>${insight.titulo}</h3>
          <div class="medium">${insight.valor}</div>
          <div class="insight ${insight.classe}">
            <i class="fas fa-info-circle"></i>
            <span>${insight.descricao}</span>
          </div>
        </div>
      `).join('');
    }

    function criarInsightsCard(dados) {
      const container = document.getElementById('insightsCard');
      let html = `
        <div class="card">
          <h3>Insights Relevantes</h3>
          <ul style="list-style-type: none; padding: 0;">
      `;

      const cpasOrdenadas = Object.entries(dados.cpas).sort((a, b) => b[1].barricadas - a[1].barricadas);
      const topCPA = cpasOrdenadas[0] ? cpasOrdenadas[0][0] : 'N/A';
      html += `<li class="insight info"><i class="fas fa-star"></i> CPA mais produtiva: ${topCPA} com ${Math.round(cpasOrdenadas[0] ? cpasOrdenadas[0][1].barricadas : 0)} remoções</li>`;

      const mediaPeso = dados.totais.barricadas > 0 ? (dados.totais.peso / dados.totais.barricadas).toFixed(2) : 0;
      html += `<li class="insight success"><i class="fas fa-balance-scale"></i> Média de peso por remoção: ${mediaPeso} toneladas</li>`;

      html += `<li class="insight warning"><i class="fas fa-map-marker-alt"></i> Municípios atendidos: ${dados.municipios.size}</li>`;

      const maxDia = dados.evolucao.reduce((max, dia) => dia.barricadas > max.barricadas ? dia : max, {barricadas: 0});
      html += `<li class="insight danger"><i class="fas fa-calendar-day"></i> Dia com mais remoções: ${maxDia.data || 'N/A'} (${Math.round(maxDia.barricadas)})</li>`;

      const periodoInicio = dados.evolucao[0]?.data || 'N/A';
      const periodoFim = dados.evolucao[dados.evolucao.length - 1]?.data || 'N/A';
      html += `<li class="insight info"><i class="fas fa-calendar-alt"></i> Período analisado: ${periodoInicio} a ${periodoFim}</li>`;

      html += '</ul></div>';
      container.innerHTML = html;
    }

    function criarCardsCPAs(dados) {
      const grid = document.getElementById('cardsCPAs');
      let html = '';
      Object.entries(dados.cpas).sort((a, b) => b[1].barricadas - a[1].barricadas).forEach(([cpa, data]) => {
        const numeroCPA = cpa.split(' ')[0];
        
        html += `
          <div class="cpa-card" onclick="abrirModalCPA('${cpa}')">
            <div class="cpa-header">
              <div class="cpa-icon">
                <div class="cpa-icon-content"></div>
              </div>
              <div class="cpa-info">
                <h4>${cpa}</h4>
                <p>${cpaComandantes[cpa] || 'Comandante não especificado'}</p>
              </div>
            </div>
            <div class="progress-container">
              <div class="progress-label">
                <span>Progresso</span>
                <span>${data.percentualBarricadas.toFixed(1)}%</span>
              </div>
              <div class="progress-bar">
                <div class="progress" style="width: ${Math.min(data.percentualBarricadas, 100)}%; background: ${colors[numeroCPA] || '#2196f3'};"></div>
              </div>
            </div>
            <div class="cpa-chart-container">
              <canvas id="chart-${cpa.replace('ª', '').replace(' ', '')}" class="cpa-chart-canvas"></canvas>
            </div>
            <div class="cpa-details">
              <div class="cpa-detail">
                <span class="cpa-detail-value">${Math.round(data.barricadas)}</span>
                <span class="cpa-detail-label">Remoções</span>
              </div>
              <div class="cpa-detail">
                <span class="cpa-detail-value">${Math.round(data.vias)}</span>
                <span class="cpa-detail-label">Vias</span>
              </div>
              <div class="cpa-detail">
                <span class="cpa-detail-value">${Math.round(data.peso)}</span>
                <span class="cpa-detail-label">Toneladas</span>
              </div>
              <div class="cpa-detail">
                <span class="cpa-detail-value">${data.eficiencia.toFixed(2)}</span>
                <span class="cpa-detail-label">Eficiência</span>
              </div>
            </div>
          </div>
        `;
      });
      grid.innerHTML = html;

      // Criar gráficos
      Object.entries(dados.cpas).forEach(([cpa, data]) => {
        const canvasId = `chart-${cpa.replace('ª', '').replace(' ', '')}`;
        const ctx = document.getElementById(canvasId);
        if (!ctx) return;
        
        if (window[`chart_${canvasId}`]) {
          window[`chart_${canvasId}`].destroy();
        }
        
        const numeroCPA = cpa.split(' ')[0];
        const corCPA = colors[numeroCPA] || '#2196f3';
        
        window[`chart_${canvasId}`] = new Chart(ctx.getContext('2d'), {
          type: 'bar',
          data: {
            labels: ['Remoções', 'Vias', 'Toneladas'],
            datasets: [{
              data: [data.barricadas, data.vias, data.peso],
              backgroundColor: [corCPA, '#2e7d32', '#f9a825'],
              borderColor: [corCPA, '#1b5e20', '#f57f17'],
              borderWidth: 1,
              borderRadius: 5,
              barPercentage: 0.6,
            }]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: {
                beginAtZero: true,
                display: false,
                grid: { display: false }
              },
              y: {
                grid: { display: false },
                ticks: { font: { size: 11 } }
              }
            },
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const label = context.label || '';
                    const value = context.raw;
                    const actualValue = Math.round(value);
                    const unit = label === 'Toneladas' ? 't' : '';
                    return `${label}: ${actualValue}${unit}`;
                  }
                }
              }
            }
          }
        });
      });
    }

    function criarCardsBPMs(dados) {
      const grid = document.getElementById('cardsBPMs');
      let html = '';
      Object.entries(dados.bpms).sort((a, b) => b[1].barricadas - a[1].barricadas).forEach(([key, data]) => {
        const numeroCPA = data.cpa.split(' ')[0];
        const corCPA = colors[numeroCPA] || '#2196f3';
        
        html += `
          <div class="area-card">
            <div class="area-header">
              <span class="area-name">${data.bpm} (${data.cpa})</span>
              <span class="area-badge" style="background: ${corCPA}; color: white;">${((data.barricadas / dados.totais.barricadas) * 100 || 0).toFixed(1)}%</span>
            </div>
            <div class="area-stats">
              <div class="area-stat">
                <span class="area-stat-value">${Math.round(data.barricadas)}</span>
                <span class="area-stat-label">Remoções</span>
              </div>
              <div class="area-stat">
                <span class="area-stat-value">${Math.round(data.vias)}</span>
                <span class="area-stat-label">Vias</span>
              </div>
              <div class="area-stat">
                <span class="area-stat-value">${Math.round(data.peso)}</span>
                <span class="area-stat-label">Toneladas</span>
              </div>
            </div>
            <div class="progress-container">
              <div class="progress-label">
                <span>Eficiência</span>
                <span>${data.eficiencia.toFixed(2)}</span>
              </div>
              <div class="progress-bar">
                <div class="progress" style="width: ${Math.min(data.eficiencia * 20, 100)}%; background: linear-gradient(90deg, #4caf50, #ffeb3b);"></div>
              </div>
            </div>
          </div>
        `;
      });
      grid.innerHTML = html;
    }

    function criarTabelaComparativaCPA(dados) {
      const tabela = document.getElementById('tabelaComparativaCPA');
      const cpasOrdenadas = Object.entries(dados.cpas).filter(([_, c]) => c.barricadas > 0).sort((a, b) => b[1].barricadas - a[1].barricadas);
      const medalhas = ['🥇', '🥈', '🥉'];
      
      let html = `
        <thead>
          <tr>
            <th style="width: 80px;">Posição</th>
            <th>CPA</th>
            <th style="text-align: center;">Comandante</th>
            <th style="text-align: center;">Remoções</th>
            <th style="text-align: center;">Vias</th>
            <th style="text-align: center;">Peso (ton)</th>
            <th style="text-align: center;">Eficiência</th>
            <th style="text-align: center;">% do Total</th>
          </tr>
        </thead>
        <tbody>
      `;
      
      if (cpasOrdenadas.length === 0) {
        html += `
          <tr>
            <td colspan="8" style="text-align: center; padding: 40px; color: var(--gray-600);">
              <i class="fas fa-database" style="font-size: 32px; opacity: 0.3; margin-bottom: 10px; display: block;"></i>
              Nenhum dado disponível para exibir
            </td>
          </tr>
        `;
      } else {
        cpasOrdenadas.forEach(([cpa, data], index) => {
          const numeroCPA = cpa.split(' ')[0];
          const corCPA = colors[numeroCPA] || '#2196f3';
          
          html += `
            <tr>
              <td class="ranking-position">
                ${index < 3 ? '<span class="ranking-medal">' + medalhas[index] + '</span>' : (index + 1) + 'º'}
              </td>
              <td><strong style="color: ${corCPA};">${cpa}</strong></td>
              <td style="text-align: center;"><small>${cpaComandantes[cpa] || 'Não especificado'}</small></td>
              <td style="text-align: center; font-weight: 600;">${Math.round(data.barricadas)}</td>
              <td style="text-align: center; font-weight: 600;">${Math.round(data.vias)}</td>
              <td style="text-align: center; font-weight: 600;">${Math.round(data.peso)}</td>
              <td style="text-align: center; font-weight: 600;">${data.eficiencia.toFixed(2)}</td>
              <td style="text-align: center;">
                <div style="display: flex; align-items: center; gap: 10px; justify-content: center;">
                  <div style="width: 80px; height: 8px; background: var(--gray-200); border-radius: 4px; overflow: hidden;">
                    <div style="width: ${data.percentualBarricadas}%; height: 100%; background: ${corCPA};"></div>
                  </div>
                  <span style="font-weight: 600;">${data.percentualBarricadas.toFixed(1)}%</span>
                </div>
              </td>
            </tr>
          `;
        });
      }
      
      html += '</tbody>';
      tabela.innerHTML = html;
    }

    function criarTabelaComparativaBPM(dados) {
      const tabela = document.getElementById('tabelaComparativaBPM');
      const bpmsOrdenadas = Object.entries(dados.bpms).filter(([_, b]) => b.barricadas > 0).sort((a, b) => b[1].barricadas - a[1].barricadas);
      const medalhas = ['🥇', '🥈', '🥉'];
      
      let html = `
        <thead>
          <tr>
            <th style="width: 80px;">Posição</th>
            <th>BPM</th>
            <th style="text-align: center;">CPA</th>
            <th style="text-align: center;">Remoções</th>
            <th style="text-align: center;">Vias</th>
            <th style="text-align: center;">Peso (ton)</th>
            <th style="text-align: center;">Eficiência</th>
            <th style="text-align: center;">% do Total</th>
          </tr>
        </thead>
        <tbody>
      `;
      
      if (bpmsOrdenadas.length === 0) {
        html += `
          <tr>
            <td colspan="8" style="text-align: center; padding: 40px; color: var(--gray-600);">
              <i class="fas fa-database" style="font-size: 32px; opacity: 0.3; margin-bottom: 10px; display: block;"></i>
              Nenhum dado disponível para exibir
            </td>
          </tr>
        `;
      } else {
        bpmsOrdenadas.forEach(([key, data], index) => {
          const percentualTotal = (data.barricadas / dados.totais.barricadas) * 100 || 0;
          const numeroCPA = data.cpa.split(' ')[0];
          const corCPA = colors[numeroCPA] || '#2196f3';
          
          html += `
            <tr>
              <td class="ranking-position">
                ${index < 3 ? '<span class="ranking-medal">' + medalhas[index] + '</span>' : (index + 1) + 'º'}
              </td>
              <td><strong style="color: ${corCPA};">${data.bpm}</strong></td>
              <td style="text-align: center;"><small>${data.cpa}</small></td>
              <td style="text-align: center; font-weight: 600;">${Math.round(data.barricadas)}</td>
              <td style="text-align: center; font-weight: 600;">${Math.round(data.vias)}</td>
              <td style="text-align: center; font-weight: 600;">${Math.round(data.peso)}</td>
              <td style="text-align: center; font-weight: 600;">${data.eficiencia.toFixed(2)}</td>
              <td style="text-align: center;">
                <div style="display: flex; align-items: center; gap: 10px; justify-content: center;">
                  <div style="width: 80px; height: 8px; background: var(--gray-200); border-radius: 4px; overflow: hidden;">
                    <div style="width: ${percentualTotal}%; height: 100%; background: ${corCPA};"></div>
                  </div>
                  <span style="font-weight: 600;">${percentualTotal.toFixed(1)}%</span>
                </div>
              </td>
            </tr>
          `;
        });
      }
      
      html += '</tbody>';
      tabela.innerHTML = html;
    }

    function criarGraficosComparativos(dados) {
      criarGraficoComparativoCPA(dados);
      criarGraficoComparativoBPM(dados);
    }

    function criarGraficoComparativoCPA(dados) {
      const ctx = document.getElementById('graficoComparativoCPA');
      if (!ctx) return;
      
      if (graficoComparativoCPA) {
        graficoComparativoCPA.destroy();
      }
      
      const cpasOrdenadas = Object.entries(dados.cpas)
        .sort((a, b) => b[1].barricadas - a[1].barricadas)
        .slice(0, 10);
      
      if (cpasOrdenadas.length === 0) {
        ctx.parentElement.innerHTML = '<div style="text-align: center; padding: 50px; color: var(--gray-600);">Nenhum dado disponível para exibir</div>';
        return;
      }
      
      const labels = cpasOrdenadas.map(([cpa]) => cpa);
      const remocoes = cpasOrdenadas.map(([_, data]) => Math.round(data.barricadas));
      const vias = cpasOrdenadas.map(([_, data]) => Math.round(data.vias));
      const pesos = cpasOrdenadas.map(([_, data]) => Math.round(data.peso));
      
      const coresBarras = labels.map(cpa => {
        const numeroCPA = cpa.split(' ')[0];
        return colors[numeroCPA] || '#2196f3';
      });
      
      graficoComparativoCPA = new Chart(ctx.getContext('2d'), {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Remoções',
              data: remocoes,
              backgroundColor: coresBarras.map(cor => cor),
              borderColor: coresBarras.map(cor => cor),
              borderWidth: 1,
              barPercentage: 0.7,
              categoryPercentage: 0.8
            },
            {
              label: 'Vias Liberadas',
              data: vias,
              backgroundColor: '#2e7d32',
              borderColor: '#1b5e20',
              borderWidth: 1,
              barPercentage: 0.7,
              categoryPercentage: 0.8
            },
            {
              label: 'Toneladas',
              data: pesos,
              backgroundColor: '#f9a825',
              borderColor: '#f57f17',
              borderWidth: 1,
              barPercentage: 0.7,
              categoryPercentage: 0.8
            }
          ]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              beginAtZero: true,
              stacked: false,
              title: {
                display: true,
                text: 'Quantidade',
                font: { size: 14, weight: 'bold' }
              },
              grid: { color: 'rgba(0,0,0,0.05)' }
            },
            y: {
              stacked: false,
              title: {
                display: true,
                text: 'CPA',
                font: { size: 14, weight: 'bold' }
              },
              grid: { color: 'rgba(0,0,0,0.05)' }
            }
          },
          plugins: {
            legend: {
              display: true,
              position: 'top',
              labels: { font: { size: 12 }, padding: 20 }
            },
            tooltip: {
              mode: 'index',
              intersect: false,
              callbacks: {
                label: function(context) {
                  const label = context.dataset.label || '';
                  const value = context.raw;
                  const unit = label === 'Toneladas' ? 't' : '';
                  return `${label}: ${value}${unit}`;
                }
              }
            }
          }
        }
      });
    }

    function criarGraficoComparativoBPM(dados) {
      const ctx = document.getElementById('graficoComparativoBPM');
      if (!ctx) return;
      
      if (graficoComparativoBPM) {
        graficoComparativoBPM.destroy();
      }
      
      const bpmsOrdenadas = Object.entries(dados.bpms)
        .sort((a, b) => b[1].barricadas - a[1].barricadas)
        .slice(0, 10);
      
      if (bpmsOrdenadas.length === 0) {
        ctx.parentElement.innerHTML = '<div style="text-align: center; padding: 50px; color: var(--gray-600);">Nenhum dado disponível para exibir</div>';
        return;
      }
      
      const labels = bpmsOrdenadas.map(([_, data]) => `${data.bpm} (${data.cpa})`);
      const remocoes = bpmsOrdenadas.map(([_, data]) => Math.round(data.barricadas));
      const vias = bpmsOrdenadas.map(([_, data]) => Math.round(data.vias));
      const pesos = bpmsOrdenadas.map(([_, data]) => Math.round(data.peso));
      
      const coresBarras = bpmsOrdenadas.map(([_, data]) => {
        const numeroCPA = data.cpa.split(' ')[0];
        return colors[numeroCPA] || '#2196f3';
      });
      
      graficoComparativoBPM = new Chart(ctx.getContext('2d'), {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Remoções',
              data: remocoes,
              backgroundColor: coresBarras.map(cor => cor),
              borderColor: coresBarras.map(cor => cor),
              borderWidth: 1,
              barPercentage: 0.7,
              categoryPercentage: 0.8
            },
            {
              label: 'Vias Liberadas',
              data: vias,
              backgroundColor: '#2e7d32',
              borderColor: '#1b5e20',
              borderWidth: 1,
              barPercentage: 0.7,
              categoryPercentage: 0.8
            },
            {
              label: 'Toneladas',
              data: pesos,
              backgroundColor: '#f9a825',
              borderColor: '#f57f17',
              borderWidth: 1,
              barPercentage: 0.7,
              categoryPercentage: 0.8
            }
          ]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              beginAtZero: true,
              stacked: false,
              title: {
                display: true,
                text: 'Quantidade',
                font: { size: 14, weight: 'bold' }
              },
              grid: { color: 'rgba(0,0,0,0.05)' }
            },
            y: {
              stacked: false,
              title: {
                display: true,
                text: 'BPM (CPA)',
                font: { size: 14, weight: 'bold' }
              },
              grid: { color: 'rgba(0,0,0,0.05)' },
              ticks: { font: { size: 11 } }
            }
          },
          plugins: {
            legend: {
              display: true,
              position: 'top',
              labels: { font: { size: 12 }, padding: 20 }
            },
            tooltip: {
              mode: 'index',
              intersect: false,
              callbacks: {
                label: function(context) {
                  const label = context.dataset.label || '';
                  const value = context.raw;
                  const unit = label === 'Toneladas' ? 't' : '';
                  return `${label}: ${value}${unit}`;
                }
              }
            }
          }
        }
      });
    }

    // ============================================================================
    // MODAL CPA E PDF
    // ============================================================================
    function abrirModalCPA(cpa) {
      document.getElementById('modalCPATitle').textContent = `Detalhes da ${cpa}`;
      document.getElementById('cpaComandante').textContent = cpaComandantes[cpa] || 'Não especificado';

      // Áreas/Equipes
      const areasList = document.getElementById('cpaAreasList');
      let areasHtml = '<div class="localidades-list">';
      (Array.from(cpaAreas[cpa] || [])).sort().forEach(area => {
        areasHtml += `<div class="localidade-item"><span class="localidade-nome">${area}</span></div>`;
      });
      areasHtml += '</div>';
      areasList.innerHTML = areasHtml || '<p>Nenhuma área registrada</p>';

      // Batalhões
      const bpmList = document.getElementById('cpaBPMList');
      let bpmHtml = '<div class="localidades-list">';
      (cpaDetails[cpa] || []).forEach(detail => {
        bpmHtml += `<div class="localidade-item">
                      <span class="localidade-nome">${detail.bpm}</span>
                      <span class="localidade-nome">${detail.areasAtuacao}</span>
                    </div>`;
      });
      bpmHtml += '</div>';
      bpmList.innerHTML = bpmHtml || '<p>Nenhum batalhão registrado</p>';

      // Localidades
      const localidadesList = document.getElementById('cpaLocalidadesList');
      let localidadesHtml = '<div class="localidades-list">';
      
      if (cpaLocalidades[cpa]) {
        const localidadesArray = Object.entries(cpaLocalidades[cpa])
          .map(([nome, count]) => ({ nome, count }))
          .sort((a, b) => b.count - a.count);
        
        if (localidadesArray.length > 0) {
          localidadesArray.forEach(local => {
            localidadesHtml += `<div class="localidade-item">
                                <span class="localidade-nome">${local.nome}</span>
                                <span class="localidade-count">${local.count} remoções</span>
                              </div>`;
          });
        } else {
          localidadesHtml = '<p>Nenhuma localidade registrada para esta CPA</p>';
        }
      } else {
        localidadesHtml = '<p>Nenhuma localidade registrada para esta CPA</p>';
      }
      
      localidadesHtml += '</div>';
      localidadesList.innerHTML = localidadesHtml;

      window.currentCPA = cpa;
      abrirModal('modalCPA');
    }

    async function gerarPDFCPA() {
      const cpa = window.currentCPA;
      if (!cpa) return;

      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({
        orientation: 'landscape',
        unit: 'mm',
        format: 'a4'
      });

      const pageWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();
      const margin = 15;
      let yPos = margin;

      // Cabeçalho
      pdf.setFillColor(13, 71, 161);
      pdf.rect(0, 0, pageWidth, 40, 'F');
      pdf.setTextColor(255, 255, 255);
      pdf.setFontSize(24);
      pdf.text(`Detalhes da ${cpa}`, pageWidth / 2, 25, { align: 'center' });

      yPos = 50;

      // Comandante
      pdf.setFillColor(245, 247, 250);
      pdf.roundedRect(margin, yPos, pageWidth - 2*margin, 30, 5, 5, 'F');
      pdf.setFillColor(13, 71, 161);
      pdf.rect(margin, yPos, 5, 30, 'F');
      pdf.setTextColor(13, 71, 161);
      pdf.setFontSize(16);
      pdf.text('Comandante', margin + 15, yPos + 10);
      pdf.setTextColor(0, 0, 0);
      pdf.setFontSize(12);
      pdf.text(cpaComandantes[cpa] || 'Não especificado', margin + 15, yPos + 20);

      yPos += 40;

      // Áreas/Equipes
      pdf.setFillColor(245, 247, 250);
      pdf.roundedRect(margin, yPos, pageWidth - 2*margin, 30, 5, 5, 'F');
      pdf.setFillColor(46, 125, 50);
      pdf.rect(margin, yPos, 5, 30, 'F');
      pdf.setTextColor(46, 125, 50);
      pdf.setFontSize(16);
      pdf.text('Áreas/Equipes Vinculadas', margin + 15, yPos + 10);
      pdf.setTextColor(0, 0, 0);
      pdf.setFontSize(12);
      let areasY = yPos + 40;
      (Array.from(cpaAreas[cpa] || [])).sort().forEach((area, idx) => {
        if (areasY > pageHeight - 20) {
          pdf.addPage();
          areasY = margin;
        }
        pdf.text(`• ${area}`, margin + 15, areasY);
        areasY += 10;
      });

      yPos = areasY + 10;

      // Batalhões
      pdf.setFillColor(245, 247, 250);
      pdf.roundedRect(margin, yPos, pageWidth - 2*margin, 30, 5, 5, 'F');
      pdf.setFillColor(249, 168, 37);
      pdf.rect(margin, yPos, 5, 30, 'F');
      pdf.setTextColor(249, 168, 37);
      pdf.setFontSize(16);
      pdf.text('Batalhões e Áreas de Atuação', margin + 15, yPos + 10);
      pdf.setTextColor(0, 0, 0);
      pdf.setFontSize(12);
      let bpmY = yPos + 40;
      (cpaDetails[cpa] || []).forEach((detail, idx) => {
        if (bpmY > pageHeight - 20) {
          pdf.addPage();
          bpmY = margin;
        }
        pdf.text(`• ${detail.bpm}: ${detail.areasAtuacao}`, margin + 15, bpmY);
        bpmY += 10;
      });

      // Localidades
      let localY = bpmY + 10;
      if (localY > pageHeight - 30) {
        pdf.addPage();
        localY = margin;
      }

      pdf.setFillColor(245, 247, 250);
      pdf.roundedRect(margin, localY, pageWidth - 2*margin, 30, 5, 5, 'F');
      pdf.setFillColor(158, 0, 89);
      pdf.rect(margin, localY, 5, 30, 'F');
      pdf.setTextColor(158, 0, 89);
      pdf.setFontSize(16);
      pdf.text('Localidades de Atuação para Remoção de Barricadas', margin + 15, localY + 10);
      pdf.setTextColor(0, 0, 0);
      pdf.setFontSize(12);
      let localidadesY = localY + 40;
      
      if (cpaLocalidades[cpa]) {
        const localidadesArray = Object.entries(cpaLocalidades[cpa])
          .map(([nome, count]) => ({ nome, count }))
          .sort((a, b) => b.count - a.count);
        
        localidadesArray.forEach((local, idx) => {
          if (localidadesY > pageHeight - 20) {
            pdf.addPage();
            localidadesY = margin;
          }
          pdf.text(`• ${local.nome} (${local.count} remoções)`, margin + 15, localidadesY);
          localidadesY += 10;
        });
      } else {
        pdf.text('Nenhuma localidade registrada', margin + 15, localidadesY);
      }

      const pdfBlob = pdf.output('blob');
      const pdfUrl = URL.createObjectURL(pdfBlob);
      document.getElementById('pdfPreview').src = pdfUrl;
      abrirModal('modalPDF');
      window.pdfParaDownload = pdf;
    }

    // ============================================================================
    // PDF GERAL
    // ============================================================================
    async function visualizarPDF() {
      if (!dadosFiltrados) {
        mostrarMensagem('Carregue os dados primeiro antes de visualizar!', 'warning');
        return;
      }
      
      mostrarMensagem('Gerando visualização do PDF... Por favor, aguarde.', 'info');
      
      try {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({
          orientation: 'landscape',
          unit: 'mm',
          format: 'a4'
        });
        
        const pageWidth = pdf.internal.pageSize.getWidth();
        const pageHeight = pdf.internal.pageSize.getHeight();
        const margin = 15;
        let yPos = margin;
        
        // Cabeçalho
        pdf.setFillColor(13, 71, 161);
        pdf.rect(0, 0, pageWidth, 35, 'F');
        
        pdf.setTextColor(255, 255, 255);
        pdf.setFontSize(24);
        pdf.setFont('helvetica', 'bold');
        pdf.text('Operação Barricada Zero - Relatório Operacional', pageWidth / 2, 15, { align: 'center' });
        
        pdf.setFontSize(12);
        pdf.setFont('helvetica', 'normal');
        const dataAtual = new Date().toLocaleDateString('pt-BR');
        pdf.text(`Período analisado: ${dadosFiltrados.evolucao[0]?.data || ''} a ${dadosFiltrados.evolucao[dadosFiltrados.evolucao.length - 1]?.data || ''}`, pageWidth / 2, 25, { align: 'center' });
        
        // Filtros
        pdf.setFontSize(10);
        const filtrosAplicados = Object.entries(filtrosAtivos).filter(([_, v]) => v !== 'todos').map(([k, v]) => `${k.charAt(0).toUpperCase() + k.slice(1)}: ${v}`).join(', ');
        const filtrosTexto = 'Filtros aplicados: ' + (filtrosAplicados || 'Nenhum');
        pdf.setTextColor(0, 0, 0);
        pdf.text(filtrosTexto, margin, 42, { maxWidth: pageWidth - 2*margin });
        
        yPos = 52;
        
        // KPIs
        const kpis = [
          { label: 'Remoções Realizadas', valor: Math.round(dadosFiltrados.totais.barricadas), cor: [13, 71, 161] },
          { label: 'Vias Liberadas', valor: Math.round(dadosFiltrados.totais.vias), cor: [2, 136, 209] },
          { label: 'Toneladas Removidas', valor: Math.round(dadosFiltrados.totais.peso), cor: [249, 168, 37] },
          { label: 'Média Diária', valor: dadosFiltrados.totais.dias > 0 ? (dadosFiltrados.totais.barricadas / dadosFiltrados.totais.dias).toFixed(1) : 0, cor: [46, 125, 50] }
        ];
        
        const cardWidth = (pageWidth - 2*margin - 15) / 4;
        const cardHeight = 28;
        
        kpis.forEach((kpi, idx) => {
          const x = margin + idx * (cardWidth + 5);
          pdf.setFillColor(245, 247, 250);
          pdf.roundedRect(x, yPos, cardWidth, cardHeight, 3, 3, 'F');
          
          pdf.setFillColor(...kpi.cor);
          pdf.rect(x, yPos, 4, cardHeight, 'F');
          
          pdf.setFontSize(10);
          pdf.setTextColor(100, 100, 100);
          pdf.text(kpi.label, x + cardWidth/2, yPos + 8, { align: 'center' });
          
          pdf.setFontSize(20);
          pdf.setTextColor(...kpi.cor);
          pdf.setFont('helvetica', 'bold');
          pdf.text(kpi.valor.toString(), x + cardWidth/2, yPos + 20, { align: 'center' });
        });
        
        yPos += cardHeight + 25;
        
        // Tabela de CPAs
        pdf.setFontSize(16);
        pdf.setTextColor(13, 71, 161);
        pdf.setFont('helvetica', 'bold');
        pdf.text('Desempenho por CPA (Dados Filtrados)', margin, yPos);
        
        yPos += 10;
        
        pdf.setFillColor(13, 71, 161);
        pdf.rect(margin, yPos, pageWidth - 2*margin, 8, 'F');
        
        pdf.setTextColor(255, 255, 255);
        pdf.setFontSize(10);
        pdf.setFont('helvetica', 'bold');
        
        let xPos = margin + 5;
        pdf.text('CPA', xPos, yPos + 5);
        xPos += 35;
        pdf.text('Comandante', xPos, yPos + 5);
        xPos += 65;
        pdf.text('Remoções', xPos, yPos + 5, { align: 'center' });
        xPos += 30;
        pdf.text('Vias', xPos, yPos + 5, { align: 'center' });
        xPos += 25;
        pdf.text('Toneladas', xPos, yPos + 5, { align: 'center' });
        xPos += 35;
        pdf.text('Eficiência', xPos, yPos + 5, { align: 'center' });
        xPos += 35;
        pdf.text('% Total', xPos, yPos + 5, { align: 'center' });
        
        yPos += 8;
        
        const cpasOrdenadas = Object.entries(dadosFiltrados.cpas).sort((a, b) => b[1].barricadas - a[1].barricadas);
        
        pdf.setTextColor(0, 0, 0);
        pdf.setFont('helvetica', 'normal');
        
        cpasOrdenadas.forEach(([cpa, data], idx) => {
          if (yPos > pageHeight - 30) {
            pdf.addPage();
            yPos = margin;
          }
          
          const fillColor = idx % 2 === 0 ? [248, 249, 250] : [255, 255, 255];
          pdf.setFillColor(...fillColor);
          pdf.rect(margin, yPos, pageWidth - 2*margin, 8, 'F');
          
          xPos = margin + 5;
          pdf.text(cpa, xPos, yPos + 5);
          xPos += 35;
          
          let comandante = cpaComandantes[cpa] || 'N/A';
          if (comandante.length > 18) {
            comandante = comandante.substring(0, 15) + '...';
          }
          pdf.text(comandante, xPos, yPos + 5);
          xPos += 65;
          pdf.text(Math.round(data.barricadas).toString(), xPos, yPos + 5, { align: 'center' });
          xPos += 30;
          pdf.text(Math.round(data.vias).toString(), xPos, yPos + 5, { align: 'center' });
          xPos += 25;
          pdf.text(Math.round(data.peso).toString(), xPos, yPos + 5, { align: 'center' });
          xPos += 35;
          pdf.text(data.eficiencia.toFixed(2), xPos, yPos + 5, { align: 'center' });
          xPos += 35;
          pdf.text(data.percentualBarricadas.toFixed(1) + '%', xPos, yPos + 5, { align: 'center' });
          
          yPos += 8;
        });
        
        if (yPos > pageHeight - 100) {
          pdf.addPage();
          yPos = margin;
        } else {
          yPos += 20;
        }
        
        pdf.setFontSize(16);
        pdf.setTextColor(13, 71, 161);
        pdf.setFont('helvetica', 'bold');
        pdf.text('Desempenho por BPM (Dados Filtrados)', margin, yPos);
        
        yPos += 10;
        
        pdf.setFillColor(13, 71, 161);
        pdf.rect(margin, yPos, pageWidth - 2*margin, 8, 'F');
        
        pdf.setTextColor(255, 255, 255);
        pdf.setFontSize(10);
        pdf.setFont('helvetica', 'bold');
        
        xPos = margin + 5;
        pdf.text('BPM', xPos, yPos + 5);
        xPos += 30;
        pdf.text('CPA', xPos, yPos + 5);
        xPos += 30;
        pdf.text('Remoções', xPos, yPos + 5, { align: 'center' });
        xPos += 35;
        pdf.text('Vias', xPos, yPos + 5, { align: 'center' });
        xPos += 35;
        pdf.text('Toneladas', xPos, yPos + 5, { align: 'center' });
        xPos += 40;
        pdf.text('Eficiência', xPos, yPos + 5, { align: 'center' });
        xPos += 40;
        pdf.text('% Total', xPos, yPos + 5, { align: 'center' });
        
        yPos += 8;
        
        const bpmsOrdenadas = Object.entries(dadosFiltrados.bpms).sort((a, b) => b[1].barricadas - a[1].barricadas);
        
        pdf.setTextColor(0, 0, 0);
        pdf.setFont('helvetica', 'normal');
        
        bpmsOrdenadas.forEach(([key, data], idx) => {
          if (yPos > pageHeight - 30) {
            pdf.addPage();
            yPos = margin;
          }
          
          const fillColor = idx % 2 === 0 ? [248, 249, 250] : [255, 255, 255];
          pdf.setFillColor(...fillColor);
          pdf.rect(margin, yPos, pageWidth - 2*margin, 8, 'F');
          
          const percentualTotal = (data.barricadas / dadosFiltrados.totais.barricadas) * 100 || 0;
          
          xPos = margin + 5;
          pdf.text(data.bpm, xPos, yPos + 5);
          xPos += 30;
          pdf.text(data.cpa, xPos, yPos + 5);
          xPos += 30;
          pdf.text(Math.round(data.barricadas).toString(), xPos, yPos + 5, { align: 'center' });
          xPos += 35;
          pdf.text(Math.round(data.vias).toString(), xPos, yPos + 5, { align: 'center' });
          xPos += 35;
          pdf.text(Math.round(data.peso).toString(), xPos, yPos + 5, { align: 'center' });
          xPos += 40;
          pdf.text(data.eficiencia.toFixed(2), xPos, yPos + 5, { align: 'center' });
          xPos += 40;
          pdf.text(percentualTotal.toFixed(1) + '%', xPos, yPos + 5, { align: 'center' });
          
          yPos += 8;
        });
        
        // Rodapé
        const totalPages = pdf.internal.getNumberOfPages();
        for (let i = 1; i <= totalPages; i++) {
          pdf.setPage(i);
          pdf.setFontSize(8);
          pdf.setTextColor(150, 150, 150);
          pdf.text(`Página ${i} de ${totalPages}`, pageWidth - margin, pageHeight - 5, { align: 'right' });
          pdf.text(`Gerado em ${dataAtual}`, margin, pageHeight - 5);
        }
        
        const pdfBlob = pdf.output('blob');
        const pdfUrl = URL.createObjectURL(pdfBlob);
        
        document.getElementById('pdfPreview').src = pdfUrl;
        abrirModal('modalPDF');
        
        window.pdfParaDownload = pdf;
        
        mostrarMensagem('PDF gerado com sucesso!', 'success');
        
      } catch (error) {
        console.error('Erro ao gerar PDF:', error);
        mostrarMensagem('Erro ao gerar PDF.', 'danger');
      }
    }

    function baixarPDF() {
      if (!window.pdfParaDownload) return mostrarMensagem('Gere o PDF primeiro!', 'warning');
      
      const dataAtual = new Date().toLocaleDateString('pt-BR').replace(/\//g, '-');
      window.pdfParaDownload.save(`Relatorio_Barricada_Zero_${dataAtual}.pdf`);
      mostrarMensagem('PDF baixado!', 'success');
    }

    // ============================================================================
    // EVENT LISTENERS
    // ============================================================================
    document.getElementById('uploadExcel').addEventListener('change', e => processarExcel(e.target.files[0]));

    // Tabs
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.getElementById(tab.dataset.tab).classList.add('active');
        
        setTimeout(() => {
          if (graficoComparativoCPA && tab.dataset.tab === 'tab-cpa') {
            graficoComparativoCPA.resize();
          }
          if (graficoComparativoBPM && tab.dataset.tab === 'tab-bpm') {
            graficoComparativoBPM.resize();
          }
        }, 100);
      });
    });

    // Modal close on outside click
    window.onclick = e => {
      if (e.target.classList.contains('modal')) fecharModal(e.target.id);
    };
  </script>
</body>
</html>